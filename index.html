<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>PartyGo - Join the Waitlist</title>

  <!-- Styles mobile-first optimisés -->
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #ff6b9d 0%, #ffa726 100%);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container { 
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      position: relative;
    }

    .background-pattern { 
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 0%, transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.05) 0%, transparent 40%),
        radial-gradient(circle at 40% 60%, rgba(255,255,255,0.08) 0%, transparent 30%),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,0.06) 0%, transparent 35%);
      animation: float 25s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes float { 
      0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
      33% { transform: translateY(-8px) scale(1.01) rotate(1deg); }
      66% { transform: translateY(5px) scale(0.99) rotate(-0.5deg); }
    }

    .card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 2rem 1.5rem;
      width: 100%;
      max-width: 420px;
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.12),
        0 4px 16px rgba(0,0,0,0.06),
        0 0 0 0.5px rgba(255,255,255,0.1);
      position: relative;
      z-index: 10;
      animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
      margin: 1rem 0;
    }
    
    @keyframes slideUp { 
      from { 
        opacity: 0; 
        transform: translateY(40px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    .logo { 
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      box-shadow: 0 8px 32px rgba(255,107,157,0.25);
      overflow: hidden;
      padding: 2px;
    }
    .logo img { 
      width: 64px; 
      height: 64px; 
      object-fit: contain;
      display: block;
    }

    .brand-name { 
      background: linear-gradient(135deg, #ff6b9d, #ffa726);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 0.5rem;
      line-height: 1.1;
    }

    .tagline { 
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      color: #2d3748;
      margin-bottom: 1rem;
      line-height: 1.3;
    }

    .subtitle { 
      font-size: 1rem;
      color: #718096;
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.5;
    }

    .form-container { 
      margin-bottom: 2rem; 
    }

    .input-group { 
      margin-bottom: 1rem; 
      position: relative;
    }

    input {
      width: 100%;
      padding: 1rem 1.25rem;
      font-size: 1.05rem;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus {
      border-color: #ff6b9d;
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
      transform: translateY(-1px);
      background: white;
    }

    input::placeholder { 
      color: #a0aec0;
      font-weight: 400;
    }

    input.error {
      border-color: #e53e3e;
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
    }

    .submit-btn {
      width: 100%;
      padding: 1.1rem 1.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, #ff6b9d, #ffa726);
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 0.5rem;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .submit-btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .submit-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 0; height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .submit-btn:active:not(:disabled)::before {
      width: 300px;
      height: 300px;
    }

    .features {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin: 2rem 0;
    }

    .feature {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(255, 107, 157, 0.1);
      font-weight: 500;
      color: #2d3748;
    }

    .feature-icon {
      width: 20px;
      height: 20px;
      color: #ff6b9d;
      flex-shrink: 0;
    }

    .feature-text {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .social-proof {
      text-align: center;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid rgba(226, 232, 240, 0.8);
    }

    .counter {
      font-size: 2.2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #ff6b9d, #ffa726);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .counter-label {
      font-size: 0.85rem;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .message {
      display: none;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      font-weight: 500;
      margin-top: 1rem;
      animation: slideUp 0.4s ease;
    }

    .success-message {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
    }

    .error-message {
      background: linear-gradient(135deg, #f56565, #e53e3e);
      color: white;
    }

    .connection-status {
      position: fixed;
      top: env(safe-area-inset-top, 1rem);
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 20;
      backdrop-filter: blur(10px);
    }

    .connection-status.online {
      background: rgba(72, 187, 120, 0.2);
      color: #2f855a;
      border: 1px solid rgba(72, 187, 120, 0.3);
    }

    .connection-status.offline {
      background: rgba(245, 101, 101, 0.2);
      color: #c53030;
      border: 1px solid rgba(245, 101, 101, 0.3);
    }

    /* Loading spinner */
    .loading-spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top: 2px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive pour tablettes */
    @media (min-width: 768px) {
      .container { padding: 2rem; }
      .card { padding: 3rem 2.5rem; max-width: 480px; }
      .brand-name { font-size: 3rem; }
      .tagline { font-size: 1.4rem; }
      .features {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
      .feature { flex-direction: column; text-align: center; padding: 1.25rem 1rem; }
      .connection-status { top: 2rem; right: 2rem; }
    }

    /* Desktop */
    @media (min-width: 1024px) {
      .card { max-width: 520px; padding: 3.5rem 3rem; }
    }

    /* Support pour les encoches iPhone */
    @supports (padding: max(0px)) {
      .container {
        padding-left: max(1rem, env(safe-area-inset-left));
        padding-right: max(1rem, env(safe-area-inset-right));
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }

    /* Optimisations pour Safari iOS */
    @media screen and (-webkit-min-device-pixel-ratio: 2) {
      input { -webkit-text-size-adjust: 100%; }
    }
  </style>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="background-pattern"></div>

  <div class="container">
    <div class="connection-status" id="connectionStatus">
      🔄 Connecting...
    </div>

    <div class="card">
      <div class="logo">
        <img src="https://uycerxczynebjatdhyef.supabase.co/storage/v1/object/public/assets/LoDi-Stylized_map_pin_with_a_star_on_top__integrating_location_and_festive_celebration__vector_icon_design__simple_and_recognizable._the_main_and_brand_color_is_purple_so_keep_this_type_and_change_the.png" alt="PartyGo Logo" />
      </div>

      <h1 class="brand-name">PartyGo</h1>
      <h2 class="tagline">Discover the best bars and parties around you.</h2>
      <p class="subtitle">
        Earn points, climb ranks, and become a legend!
      </p>

      <form class="form-container" id="waitlistForm">
        <div class="input-group">
          <input 
            type="text" 
            placeholder="Your name" 
            required 
            id="name" 
            autocomplete="name" 
            minlength="2"
          >
        </div>
        <div class="input-group">
          <input 
            type="email" 
            placeholder="Your email" 
            required 
            id="email" 
            autocomplete="email"
          >
        </div>
        <button type="submit" class="submit-btn" id="submitBtn">
          <div class="loading-spinner" id="loadingSpinner"></div>
          <span id="buttonText">Join the Waitlist</span>
        </button>

        <div class="message success-message" id="successMessage">
          🎉 You're in! Welcome to the PartyGo's journey
        </div>

        <div class="message error-message" id="errorMessage">
          Something went wrong. Please try again.
        </div>
      </form>

      <div class="features">
        <div class="feature">
          <svg class="feature-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
          </svg>
          <span class="feature-text">Priority Access</span>
        </div>
        <div class="feature">
          <svg class="feature-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="feature-text">Extra points</span>
        </div>
        <div class="feature">
          <svg class="feature-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
          <span class="feature-text">Rewards</span>
        </div>
      </div>

      <div class="social-proof">
        <div class="counter" id="counter">100</div>
        <div class="counter-label">People waiting</div>
      </div>
    </div>
  </div>

  <script>
    // Configuration Supabase
    const SUPABASE_URL = "https://uycerxczynebjatdhyef.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5Y2VyeGN6eW5lYmphdGRoeWVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4ODI1NTAsImV4cCI6MjA3MjQ1ODU1MH0.KrEdzR5UnuRw2zj95hJDn4BfeiaYHS3O--ZcYOPQL58";

    let supabaseClient;
    let isConnected = false;
    let currentCount = 100;

    function updateConnectionStatus(online) {
      const status = document.getElementById('connectionStatus');
      status.textContent = online ? '🟢 Online' : '🔴 Offline';
      status.className = `connection-status ${online ? 'online' : 'offline'}`;
      isConnected = online;
    }

    function showMessage(type, customText = null) {
      ['successMessage', 'errorMessage'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      
      const element = document.getElementById(`${type}Message`);
      if (customText) element.textContent = customText;
      element.style.display = 'block';
      
      setTimeout(() => element.style.display = 'none', 4000);
    }

    function setButtonLoading(loading) {
      const btn = document.getElementById('submitBtn');
      const spinner = document.getElementById('loadingSpinner');
      const text = document.getElementById('buttonText');
      
      btn.disabled = loading;
      spinner.style.display = loading ? 'inline-block' : 'none';
      text.textContent = loading ? 'Joining...' : 'Join the Waitlist';
    }

    // VALIDATION D'EMAIL RENFORCÉE
    function isValidEmail(email) {
      // Regex plus stricte
      const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
      
      if (!emailRegex.test(email)) return false;
      
      // Vérifications supplémentaires
      const domain = email.split('@')[1]?.toLowerCase();
      const localPart = email.split('@')[0]?.toLowerCase();
      
      // Domaines jetables courants à bloquer
      const disposableDomains = [
        '10minutemail.com', 'tempmail.org', 'guerrillamail.com', 
        'mailinator.com', 'temp-mail.org', 'throwaway.email',
        'yopmail.com', 'maildrop.cc', 'temp-mail.io',
        'mohmal.com', 'sharklasers.com', 'grr.la'
      ];
      
      // Patterns suspects
      const suspiciousPatterns = [
        /^test/i,
        /^fake/i,
        /^example/i,
        /\d{8,}/, // 8+ chiffres consécutifs
        /^[a-z]{15,}$/i // 15+ lettres consécutives sans chiffres/caractères
      ];
      
      // Domaines suspects
      const suspiciousDomains = [
        'test.com', 'fake.com', 'example.com', 'test.fr', 'fake.fr'
      ];
      
      if (disposableDomains.includes(domain)) return false;
      if (suspiciousDomains.includes(domain)) return false;
      if (suspiciousPatterns.some(pattern => pattern.test(localPart))) return false;
      
      // Le domaine doit avoir au moins un point
      if (!domain || !domain.includes('.')) return false;
      
      // Longueurs raisonnables
      if (localPart.length > 64 || domain.length > 253) return false;
      
      return true;
    }

    // Validation en temps réel
    function validateEmailRealTime(email) {
      const input = document.getElementById('email');
      
      if (!email) {
        input.setCustomValidity('');
        return true;
      }
      
      if (!isValidEmail(email)) {
        input.setCustomValidity('Please enter a valid email address');
        return false;
      }
      
      input.setCustomValidity('');
      return true;
    }

    function animateCounter(target) {
      const counter = document.getElementById('counter');
      let current = Math.max(100, currentCount);
      const increment = Math.max(1, (target - current) / 60);
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          current = target;
          clearInterval(timer);
        }
        counter.textContent = Math.floor(current).toLocaleString();
        currentCount = Math.floor(current);
      }, 20);
    }

    function incrementCounter() {
      currentCount++;
      const counter = document.getElementById('counter');
      
      counter.style.transform = 'scale(1.1)';
      counter.style.transition = 'transform 0.2s ease';
      
      setTimeout(() => {
        counter.textContent = currentCount.toLocaleString();
        counter.style.transform = 'scale(1)';
      }, 100);

      localStorage.setItem('partygo-counter', currentCount.toString());
    }

    function loadSavedCounter() {
      const saved = localStorage.getItem('partygo-counter');
      if (saved) {
        currentCount = Math.max(100, parseInt(saved));
      }
      return currentCount;
    }

    async function loadStats() {
      try {
        const { count } = await supabaseClient
          .from('waitlist')
          .select('*', { count: 'exact', head: true });
        
        return (count || 0) + 100;
      } catch (error) {
        console.warn('Could not load stats from Supabase:', error);
        return currentCount;
      }
    }

    // FONCTION: Envoyer email via Supabase Edge Function + Resend
    async function sendWelcomeEmailResend(name, email) {
      try {
        console.log(`Sending welcome email via Resend to ${name} (${email})`);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/send-welcome-email`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: name,
            email: email
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Email sent successfully via Resend:', result);
          return { success: true };
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to send email');
        }
        
      } catch (error) {
        console.error('Resend failed:', error);
        return { success: false, error };
      }
    }

    async function init() {
      try {
        const savedCount = loadSavedCounter();
        
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        
        const { error } = await supabaseClient
          .from('waitlist')
          .select('id')
          .limit(1);

        updateConnectionStatus(!error);
        
        if (error && error.message.includes('relation') && error.message.includes('does not exist')) {
          showMessage('error', '⚠️ Database not configured yet');
          animateCounter(savedCount);
        } else {
          const realCount = await loadStats();
          const finalCount = Math.max(savedCount, realCount);
          animateCounter(finalCount);
        }
        
      } catch (err) {
        console.error('Init error:', err);
        updateConnectionStatus(false);
        animateCounter(loadSavedCounter());
      }

      // Event listeners pour validation en temps réel
      document.getElementById('email').addEventListener('input', (e) => {
        validateEmailRealTime(e.target.value);
      });

      document.getElementById('email').addEventListener('blur', (e) => {
        const email = e.target.value.trim();
        if (email && !isValidEmail(email)) {
          showMessage('error', 'Please enter a valid email address');
        }
      });
    }

    document.getElementById('waitlistForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById('name');
      const emailInput = document.getElementById('email');
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();

      nameInput.classList.remove('error');
      emailInput.classList.remove('error');

      let hasError = false;
      if (!name || name.length < 2) {
        nameInput.classList.add('error');
        hasError = true;
      }
      if (!email || !isValidEmail(email)) {
        emailInput.classList.add('error');
        hasError = true;
      }

      if (hasError) {
        showMessage('error', '❌ Please fill in all fields correctly');
        return;
      }

      if (!isConnected) {
        showMessage('error', '❌ No connection. Please try again.');
        return;
      }

      setButtonLoading(true);

      try {
        // Insérer dans Supabase
        const { data, error } = await supabaseClient
          .from('waitlist')
          .insert([{ name, email }])
          .select();

        if (!error && data) {
          showMessage('success');
          document.getElementById('waitlistForm').reset();

          // ENVOYER L'EMAIL DE BIENVENUE VIA RESEND
          try {
            await sendWelcomeEmailResend(name, email);
          } catch (emailError) {
            console.warn('Email sending failed:', emailError);
          }

          incrementCounter();
          
        } else {
          if (error?.code === '23505') {
            showMessage('error', '⚠️ Email already registered!');
          } else {
            showMessage('error', '❌ Registration failed. Try again.');
          }
        }
      } catch (err) {
        showMessage('error', '❌ Network error. Check connection.');
      } finally {
        setButtonLoading(false);
      }
    });

    setInterval(async () => {
      if (isConnected) {
        try {
          const realCount = await loadStats();
          if (realCount > currentCount) {
            currentCount = realCount;
            document.getElementById('counter').textContent = currentCount.toLocaleString();
            localStorage.setItem('partygo-counter', currentCount.toString());
          }
        } catch (error) {
          console.warn('Failed to sync stats:', error);
        }
      }
    }, 60000);

    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      document.addEventListener('touchstart', function() {}, true);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
